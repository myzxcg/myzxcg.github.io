<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark">
    <head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#">
    <meta charset="UTF-8" />

    <meta name="generator" content="Hugo 0.109.0"><meta name="theme-color" content="#16171d" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <meta name="format-detection" content="telephone=no, date=no, address=no, email=no" />
    
    <meta http-equiv="Cache-Control" content="no-transform" />
    
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <title>白驱动 Kill AV/EDR（上） | MYZXCG</title>

    <link rel="stylesheet" href="/css/meme.min.248ffc922f6c9975e8625f71e7ebc1a9e2180e744b9528665612bf7c124dea69.css"/>

    
    
        <script src="/js/meme.min.6d72b01d76c00f0b1e95d1e597afb2c3ca8bfbfe2c7fa68474010ae38dec477d.js"></script>

    

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" media="print" onload="this.media='all'" />
        <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=EB&#43;Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&amp;family=Noto&#43;Serif&#43;SC:wght@400;500;700&amp;family=Source&#43;Code&#43;Pro:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" /></noscript>

    <meta name="author" content="myzxcg" /><meta name="description" content="本文是白驱动Kill AV/EDR 的第一部分，将讨论驱动开发原理，杀软/EDR 监控拦截原理，并且……" />

    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg" color="" />
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="MYZXCG" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="application-name" content="MYZXCG" />
    <meta name="msapplication-starturl" content="../../../../" />
    <meta name="msapplication-TileColor" content="#603cba" />
    <meta name="msapplication-TileImage" content="../../../../icons/mstile-150x150.png" />
    <link rel="manifest" href="/manifest.json" />


    
    

    
    <link rel="canonical" href="https://myzxcg.com/2023/09/%E7%99%BD%E9%A9%B1%E5%8A%A8-Kill-AV/EDR%E4%B8%8A/" />
    

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "datePublished": "2023-09-22T16:19:54+08:00",
        "dateModified": "2023-09-22T16:52:46+08:00",
        "url": "https://myzxcg.com/2023/09/%E7%99%BD%E9%A9%B1%E5%8A%A8-Kill-AV/EDR%E4%B8%8A/",
        "headline": "白驱动 Kill AV/EDR（上）",
        "description": "本文是白驱动Kill AV/EDR 的第一部分，将讨论驱动开发原理，杀软/EDR 监控拦截原理，并且……",
        "inLanguage" : "zh-CN",
        "articleSection": "posts",
        "wordCount":  7511 ,
        "image": ["https://myzxcg.com/images/16953709776012.jpg","https://myzxcg.com/images/16953710050745.jpg","https://myzxcg.com/images/16953710258941.jpg","https://myzxcg.com/images/16953710419701.jpg","https://myzxcg.com/images/16953710836499.jpg","https://myzxcg.com/images/16953711256227.jpg","https://myzxcg.com/images/16953711615219.jpg","https://myzxcg.com/images/16953711739953.jpg","https://myzxcg.com/images/16953712117568.jpg","https://myzxcg.com/images/16953712494454.jpg","https://myzxcg.com/images/16953712633898.jpg","https://myzxcg.com/images/16953727256091.jpg"],
        "author": {
            "@type": "Person",
            "description": "专注于Web安全、内网渗透. 记录学习与渗透过程中遇到的有意思的点, 分享技巧与知识. 欢迎交流～",
            "email": "myzx.xcg@gmail.com",
            "image": "https://myzxcg.com/avatar.png",
            "url": "https://myzxcg.com/",
            "name": "myzxcg"
        },
        "license": "[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)",
        "publisher": {
            "@type": "Organization",
            "name": "MYZXCG",
            "logo": {
                "@type": "ImageObject",
                "url": "https://myzxcg.com/icons/favicon.ico"
            },
            "url": "https://myzxcg.com/"
        },
        "mainEntityOfPage": {
            "@type": "WebSite",
            "@id": "https://myzxcg.com/"
        }
    }
</script>

    

<meta name="twitter:card" content="summary_large_image" />


<meta name="twitter:site" content="@myzxcg" />
<meta name="twitter:creator" content="@myzxcg" />

    



<meta property="og:title" content="白驱动 Kill AV/EDR（上）" />
<meta property="og:description" content="本文是白驱动Kill AV/EDR 的第一部分，将讨论驱动开发原理，杀软/EDR 监控拦截原理，并且……" />
<meta property="og:url" content="https://myzxcg.com/2023/09/%E7%99%BD%E9%A9%B1%E5%8A%A8-Kill-AV/EDR%E4%B8%8A/" />
<meta property="og:site_name" content="MYZXCG" />
<meta property="og:locale" content="zh" /><meta property="og:image" content="https://myzxcg.com/images/16953709776012.jpg" />
<meta property="og:type" content="article" />
    <meta property="article:published_time" content="2023-09-22T16:19:54&#43;08:00" />
    <meta property="article:modified_time" content="2023-09-22T16:52:46&#43;08:00" />
    
    <meta property="article:section" content="posts" />


        <link rel="preconnect" href="https://www.google-analytics.com" crossorigin />

        


    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0LZRMN44V"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-Y0LZRMN44V');
    </script>




    
    

    
</head>

    <body>
        <div class="container">
            
    <header class="header">
        
            <div class="header-wrapper">
                <div class="header-inner single">
                    
    <div class="site-brand">
        
            <a href="/"><svg data-v-423bf9ae="" xmlns="http://www.w3.org/2000/svg" class="brand" viewBox="0 0 164.20314694661778 60" class="font"><!----><defs data-v-423bf9ae=""><linearGradient data-v-423bf9ae="" gradientTransform="rotate(25)" id="9d5bfb87-9af0-4056-b335-e722243993f9" x1="0%" y1="0%" x2="100%" y2="0%"><stop data-v-423bf9ae="" offset="0%" style="stop-color: rgb(87, 93, 96); stop-opacity: 1;"></stop><stop data-v-423bf9ae="" offset="100%" style="stop-color: rgb(246, 225, 205); stop-opacity: 1;"></stop></linearGradient></defs><!----><g data-v-423bf9ae="" id="2fa46697-71c2-43ec-b51a-6d9e651e9e88" fill="#ffffff" transform="matrix(4.687500279396789,0,0,4.687500279396789,-2.1562506803318087,-24.703126859851267)"><path d="M7.24 13.04L7.24 13.04L7.24 13.04Q7.26 13.09 7.27 13.13L7.27 13.13L7.27 13.13Q7.28 13.16 7.28 13.19L7.28 13.19L7.28 13.19Q7.28 13.25 7.23 13.27L7.23 13.27L7.23 13.27Q7.18 13.28 7.12 13.29L7.12 13.29L7.12 13.29Q7.11 13.30 7.10 13.35L7.10 13.35L7.10 13.35Q7.08 13.41 7.06 13.48L7.06 13.48L7.06 13.48Q7.03 13.55 6.98 13.60L6.98 13.60L6.98 13.60Q6.93 13.66 6.84 13.66L6.84 13.66L6.84 13.66Q6.56 13.64 6.39 13.53L6.39 13.53L6.39 13.53Q6.23 13.43 6.15 13.24L6.15 13.24L6.15 13.24Q6.06 13.06 6.04 12.80L6.04 12.80L6.04 12.80Q6.02 12.54 6.02 12.23L6.02 12.23L6.02 12.23Q6.02 11.86 6.05 11.46L6.05 11.46L6.05 11.46Q6.08 11.05 6.13 10.67L6.13 10.67L6.13 10.67Q6.17 10.29 6.20 9.95L6.20 9.95L6.20 9.95Q6.23 9.61 6.23 9.37L6.23 9.37L6.23 9.37Q6.23 9.02 6.17 8.83L6.17 8.83L6.17 8.83Q6.11 8.64 6.01 8.64L6.01 8.64L6.01 8.64Q5.96 8.64 5.76 8.92L5.76 8.92L5.76 8.92Q5.56 9.21 5.29 9.78L5.29 9.78L5.29 9.78Q5.01 10.36 4.69 11.22L4.69 11.22L4.69 11.22Q4.38 12.09 4.09 13.26L4.09 13.26L4.09 13.26Q4.07 13.31 4.07 13.36L4.07 13.36L4.07 13.36Q4.07 13.42 4.07 13.46L4.07 13.46L4.07 13.46Q4.06 13.51 4.04 13.54L4.04 13.54L4.04 13.54Q4.01 13.57 3.96 13.57L3.96 13.57L3.96 13.57Q3.87 13.57 3.81 13.53L3.81 13.53L3.81 13.53Q3.76 13.49 3.72 13.45L3.72 13.45L3.72 13.45Q3.68 13.41 3.64 13.37L3.64 13.37L3.64 13.37Q3.61 13.33 3.55 13.33L3.55 13.33L3.55 13.33Q3.53 13.33 3.52 13.36L3.52 13.36L3.52 13.36Q3.51 13.38 3.49 13.42L3.49 13.42L3.49 13.42Q3.47 13.46 3.44 13.49L3.44 13.49L3.44 13.49Q3.41 13.51 3.36 13.51L3.36 13.51L3.36 13.51Q3.32 13.51 3.27 13.50L3.27 13.50L3.27 13.50Q3.23 13.48 3.18 13.41L3.18 13.41L3.18 13.41Q3.13 13.34 3.10 13.20L3.10 13.20L3.10 13.20Q3.07 13.06 3.07 12.82L3.07 12.82L3.07 12.51L3.07 12.51Q3.07 12.41 3.09 12.21L3.09 12.21L3.09 12.21Q3.11 12.01 3.13 11.74L3.13 11.74L3.13 11.74Q3.16 11.48 3.19 11.17L3.19 11.17L3.19 11.17Q3.22 10.86 3.24 10.53L3.24 10.53L3.24 10.53Q3.27 10.21 3.28 9.91L3.28 9.91L3.28 9.91Q3.30 9.60 3.30 9.34L3.30 9.34L3.30 9.34Q3.30 8.57 3.11 8.57L3.11 8.57L3.11 8.57Q3.06 8.57 3.00 8.61L3.00 8.61L3.00 8.61Q2.94 8.64 2.85 8.75L2.85 8.75L2.85 8.75Q2.77 8.85 2.66 9.05L2.66 9.05L2.66 9.05Q2.54 9.24 2.40 9.57L2.40 9.57L2.40 9.57Q2.26 9.89 2.08 10.36L2.08 10.36L2.08 10.36Q1.90 10.83 1.68 11.48L1.68 11.48L1.68 11.48Q1.63 11.63 1.58 11.90L1.58 11.90L1.58 11.90Q1.52 12.18 1.47 12.47L1.47 12.47L1.47 12.47Q1.42 12.76 1.39 13.00L1.39 13.00L1.39 13.00Q1.36 13.24 1.36 13.32L1.36 13.32L1.36 13.32Q1.36 13.34 1.29 13.38L1.29 13.38L1.29 13.38Q1.22 13.43 1.12 13.47L1.12 13.47L1.12 13.47Q1.03 13.51 0.93 13.54L0.93 13.54L0.93 13.54Q0.83 13.57 0.77 13.57L0.77 13.57L0.77 13.57Q0.66 13.57 0.59 13.50L0.59 13.50L0.59 13.50Q0.53 13.44 0.50 13.27L0.50 13.27L0.50 13.27Q0.47 13.09 0.47 12.79L0.47 12.79L0.47 12.79Q0.46 12.48 0.46 12.00L0.46 12.00L0.46 12.00Q0.46 11.88 0.48 11.52L0.48 11.52L0.48 11.52Q0.49 11.16 0.51 10.68L0.51 10.68L0.51 10.68Q0.54 10.21 0.58 9.70L0.58 9.70L0.58 9.70Q0.62 9.18 0.68 8.75L0.68 8.75L0.68 8.75Q0.73 8.32 0.81 8.04L0.81 8.04L0.81 8.04Q0.88 7.76 0.98 7.76L0.98 7.76L0.98 7.76Q1.03 7.76 1.07 7.79L1.07 7.79L1.07 7.79Q1.11 7.83 1.14 7.86L1.14 7.86L1.14 7.86Q1.18 7.90 1.21 7.94L1.21 7.94L1.21 7.94Q1.24 7.97 1.27 7.97L1.27 7.97L1.27 7.97Q1.30 7.97 1.33 7.94L1.33 7.94L1.33 7.94Q1.36 7.92 1.38 7.88L1.38 7.88L1.38 7.88Q1.41 7.84 1.43 7.81L1.43 7.81L1.43 7.81Q1.46 7.79 1.47 7.79L1.47 7.79L1.47 7.79Q1.49 7.79 1.53 7.85L1.53 7.85L1.53 7.85Q1.57 7.92 1.61 8.02L1.61 8.02L1.61 8.02Q1.65 8.11 1.68 8.21L1.68 8.21L1.68 8.21Q1.71 8.31 1.71 8.36L1.71 8.36L1.71 8.36Q1.71 8.50 1.69 8.75L1.69 8.75L1.69 8.75Q1.66 9.00 1.63 9.31L1.63 9.31L1.63 9.31Q1.60 9.61 1.58 9.93L1.58 9.93L1.58 9.93Q1.55 10.24 1.55 10.51L1.55 10.51L1.55 10.53L1.55 10.53Q1.64 10.24 1.76 9.93L1.76 9.93L1.76 9.93Q1.88 9.62 2.02 9.32L2.02 9.32L2.02 9.32Q2.17 9.02 2.33 8.76L2.33 8.76L2.33 8.76Q2.49 8.49 2.67 8.29L2.67 8.29L2.67 8.29Q2.84 8.09 3.03 7.98L3.03 7.98L3.03 7.98Q3.21 7.86 3.40 7.86L3.40 7.86L3.40 7.86Q3.64 7.86 3.80 7.94L3.80 7.94L3.80 7.94Q3.97 8.02 4.07 8.16L4.07 8.16L4.07 8.16Q4.18 8.30 4.22 8.48L4.22 8.48L4.22 8.48Q4.27 8.66 4.27 8.87L4.27 8.87L4.27 8.87Q4.27 9.04 4.25 9.28L4.25 9.28L4.25 9.28Q4.22 9.51 4.20 9.79L4.20 9.79L4.20 9.79Q4.17 10.08 4.15 10.41L4.15 10.41L4.15 10.41Q4.12 10.75 4.12 11.15L4.12 11.15L4.12 11.15Q4.20 10.90 4.33 10.56L4.33 10.56L4.33 10.56Q4.46 10.21 4.61 9.84L4.61 9.84L4.61 9.84Q4.76 9.47 4.94 9.11L4.94 9.11L4.94 9.11Q5.11 8.75 5.29 8.46L5.29 8.46L5.29 8.46Q5.47 8.18 5.65 8.00L5.65 8.00L5.65 8.00Q5.83 7.82 6.00 7.82L6.00 7.82L6.00 7.82Q6.04 7.82 6.21 7.85L6.21 7.85L6.21 7.85Q6.38 7.88 6.57 7.94L6.57 7.94L6.57 7.94Q6.75 8.00 6.92 8.08L6.92 8.08L6.92 8.08Q7.08 8.17 7.14 8.28L7.14 8.28L7.14 8.28Q7.19 8.39 7.24 8.60L7.24 8.60L7.24 8.60Q7.28 8.81 7.28 9.16L7.28 9.16L7.28 9.16Q7.28 9.47 7.24 9.90L7.24 9.90L7.24 9.90Q7.19 10.32 7.08 10.92L7.08 10.92L7.08 10.92Q7.05 11.12 7.04 11.31L7.04 11.31L7.04 11.31Q7.03 11.49 7.03 11.67L7.03 11.67L7.03 11.67Q7.03 11.93 7.05 12.15L7.05 12.15L7.05 12.15Q7.08 12.38 7.11 12.56L7.11 12.56L7.11 12.56Q7.14 12.74 7.18 12.86L7.18 12.86L7.18 12.86Q7.21 12.99 7.24 13.04ZM13.92 7.93L13.92 7.93L13.92 7.93Q13.90 7.96 13.78 8.16L13.78 8.16L13.78 8.16Q13.66 8.35 13.47 8.65L13.47 8.65L13.47 8.65Q13.29 8.95 13.05 9.33L13.05 9.33L13.05 9.33Q12.82 9.71 12.57 10.11L12.57 10.11L12.57 10.11Q12.32 10.52 12.07 10.92L12.07 10.92L12.07 10.92Q11.83 11.33 11.61 11.68L11.61 11.68L11.61 11.68Q11.40 12.03 11.24 12.30L11.24 12.30L11.24 12.30Q11.08 12.58 11.01 12.71L11.01 12.71L11.01 12.71Q10.93 12.85 10.79 13.14L10.79 13.14L10.79 13.14Q10.66 13.43 10.48 13.80L10.48 13.80L10.48 13.80Q10.30 14.17 10.10 14.60L10.10 14.60L10.10 14.60Q9.90 15.03 9.70 15.47L9.70 15.47L9.70 15.47Q9.50 15.90 9.31 16.31L9.31 16.31L9.31 16.31Q9.12 16.71 8.97 17.04L8.97 17.04L8.97 17.04Q8.83 17.36 8.73 17.56L8.73 17.56L8.73 17.56Q8.63 17.77 8.62 17.81L8.62 17.81L8.62 17.81Q8.56 17.97 8.51 18.01L8.51 18.01L8.51 18.01Q8.46 18.05 8.36 18.07L8.36 18.07L8.36 18.07Q8.31 18.07 8.29 18.04L8.29 18.04L8.29 18.04Q8.26 18.01 8.24 17.96L8.24 17.96L8.24 17.96Q8.22 17.91 8.20 17.87L8.20 17.87L8.20 17.87Q8.18 17.83 8.15 17.83L8.15 17.83L8.15 17.83Q8.06 17.81 8.05 17.79L8.05 17.79L8.05 17.79Q8.04 17.77 8.00 17.70L8.00 17.70L8.00 17.70Q7.98 17.67 7.96 17.67L7.96 17.67L7.96 17.67Q7.94 17.66 7.92 17.66L7.92 17.66L7.92 17.66Q7.90 17.66 7.89 17.66L7.89 17.66L7.89 17.66Q7.88 17.65 7.88 17.62L7.88 17.62L7.88 17.62Q7.90 17.50 7.91 17.38L7.91 17.38L7.91 17.38Q7.92 17.27 7.94 17.17L7.94 17.17L7.94 17.17Q7.96 17.10 8.08 16.86L8.08 16.86L8.08 16.86Q8.20 16.62 8.37 16.27L8.37 16.27L8.37 16.27Q8.55 15.93 8.77 15.51L8.77 15.51L8.77 15.51Q9.00 15.09 9.23 14.65L9.23 14.65L9.23 14.65Q9.45 14.22 9.68 13.79L9.68 13.79L9.68 13.79Q9.90 13.37 10.08 13.02L10.08 13.02L10.08 13.02Q9.99 12.83 9.84 12.53L9.84 12.53L9.84 12.53Q9.69 12.22 9.51 11.85L9.51 11.85L9.51 11.85Q9.33 11.48 9.13 11.06L9.13 11.06L9.13 11.06Q8.93 10.64 8.74 10.23L8.74 10.23L8.74 10.23Q8.54 9.82 8.37 9.44L8.37 9.44L8.37 9.44Q8.19 9.06 8.06 8.75L8.06 8.75L8.06 8.75Q7.92 8.45 7.85 8.25L7.85 8.25L7.85 8.25Q7.77 8.05 7.77 8.00L7.77 8.00L7.77 8.00Q7.78 7.92 7.81 7.89L7.81 7.89L7.81 7.89Q7.83 7.85 7.88 7.85L7.88 7.85L7.88 7.85Q7.92 7.85 7.97 7.88L7.97 7.88L7.97 7.88Q8.03 7.90 8.08 7.92L8.08 7.92L8.08 7.92Q8.16 7.95 8.24 7.98L8.24 7.98L8.24 7.98Q8.31 8.01 8.35 7.96L8.35 7.96L8.35 7.96Q8.37 7.90 8.46 7.90L8.46 7.90L8.46 7.90Q8.56 7.90 8.62 7.93L8.62 7.93L8.62 7.93Q8.64 7.95 8.66 7.94L8.66 7.94L8.66 7.94Q8.67 7.94 8.69 7.92L8.69 7.92L8.69 7.92Q8.71 7.90 8.73 7.87L8.73 7.87L8.73 7.87Q8.76 7.85 8.79 7.83L8.79 7.83L8.79 7.83Q8.87 7.82 8.93 7.86L8.93 7.86L8.93 7.86Q8.99 7.90 9.04 8.04L9.04 8.04L9.04 8.04Q9.08 8.14 9.18 8.39L9.18 8.39L9.18 8.39Q9.29 8.65 9.44 8.98L9.44 8.98L9.44 8.98Q9.58 9.32 9.76 9.70L9.76 9.70L9.76 9.70Q9.94 10.09 10.12 10.46L10.12 10.46L10.12 10.46Q10.29 10.83 10.46 11.16L10.46 11.16L10.46 11.16Q10.62 11.49 10.74 11.71L10.74 11.71L10.74 11.71Q10.92 11.37 11.14 10.98L11.14 10.98L11.14 10.98Q11.35 10.60 11.58 10.21L11.58 10.21L11.58 10.21Q11.80 9.82 12.02 9.45L12.02 9.45L12.02 9.45Q12.24 9.08 12.43 8.77L12.43 8.77L12.43 8.77Q12.63 8.46 12.78 8.22L12.78 8.22L12.78 8.22Q12.93 7.98 13.02 7.86L13.02 7.86L13.02 7.86Q13.08 7.79 13.08 7.77L13.08 7.77L13.08 7.77Q13.08 7.75 13.13 7.73L13.13 7.73L13.13 7.73Q13.17 7.72 13.20 7.70L13.20 7.70L13.20 7.70Q13.23 7.69 13.30 7.70L13.30 7.70L13.30 7.70Q13.36 7.72 13.40 7.72L13.40 7.72L13.40 7.72Q13.43 7.72 13.45 7.76L13.45 7.76L13.45 7.76Q13.47 7.78 13.49 7.77L13.49 7.77L13.49 7.77Q13.52 7.77 13.56 7.75L13.56 7.75L13.56 7.75Q13.60 7.73 13.64 7.71L13.64 7.71L13.64 7.71Q13.68 7.70 13.72 7.70L13.72 7.70L13.72 7.70Q13.77 7.71 13.82 7.72L13.82 7.72L13.82 7.72Q13.86 7.73 13.90 7.76L13.90 7.76L13.90 7.76Q13.94 7.79 13.95 7.83L13.95 7.83L13.95 7.83Q13.95 7.87 13.92 7.93ZM18.94 8.25L18.94 8.25L18.94 8.25Q18.92 8.29 18.90 8.31L18.90 8.31L18.90 8.31Q18.89 8.33 18.86 8.35L18.86 8.35L18.86 8.35Q18.83 8.37 18.79 8.40L18.79 8.40L18.79 8.40Q18.75 8.44 18.69 8.49L18.69 8.49L18.69 8.49Q18.57 8.58 18.30 8.83L18.30 8.83L18.30 8.83Q18.03 9.08 17.66 9.43L17.66 9.43L17.66 9.43Q17.30 9.78 16.89 10.19L16.89 10.19L16.89 10.19Q16.47 10.60 16.08 11.02L16.08 11.02L16.08 11.02Q15.68 11.43 15.34 11.81L15.34 11.81L15.34 11.81Q15.00 12.18 14.78 12.46L14.78 12.46L14.78 12.46Q15.05 12.41 15.41 12.37L15.41 12.37L15.41 12.37Q15.77 12.32 16.15 12.29L16.15 12.29L16.15 12.29Q16.54 12.26 16.92 12.24L16.92 12.24L16.92 12.24Q17.29 12.22 17.61 12.22L17.61 12.22L17.61 12.22Q18.03 12.22 18.25 12.26L18.25 12.26L18.25 12.26Q18.37 12.27 18.45 12.34L18.45 12.34L18.45 12.34Q18.54 12.40 18.60 12.48L18.60 12.48L18.60 12.48Q18.66 12.55 18.69 12.63L18.69 12.63L18.69 12.63Q18.72 12.70 18.72 12.74L18.72 12.74L18.72 12.74Q18.72 12.80 18.72 12.86L18.72 12.86L18.72 12.86Q18.73 12.91 18.72 12.96L18.72 12.96L18.72 12.96Q18.71 13.01 18.67 13.05L18.67 13.05L18.67 13.05Q18.63 13.09 18.53 13.11L18.53 13.11L18.53 13.11Q18.48 13.13 18.41 13.11L18.41 13.11L18.41 13.11Q18.33 13.10 18.27 13.08L18.27 13.08L18.27 13.08Q18.20 13.07 18.14 13.06L18.14 13.06L18.14 13.06Q18.08 13.06 18.06 13.08L18.06 13.08L18.06 13.08Q17.99 13.18 18.03 13.25L18.03 13.25L18.03 13.25Q18.07 13.32 18.17 13.41L18.17 13.41L18.17 13.41Q18.22 13.44 18.20 13.48L18.20 13.48L18.20 13.48Q18.18 13.53 18.10 13.56L18.10 13.56L18.10 13.56Q18.03 13.58 17.91 13.58L17.91 13.58L17.91 13.58Q17.79 13.58 17.65 13.54L17.65 13.54L17.65 13.54Q17.59 13.52 17.44 13.51L17.44 13.51L17.44 13.51Q17.29 13.49 17.09 13.48L17.09 13.48L17.09 13.48Q16.89 13.47 16.64 13.47L16.64 13.47L16.64 13.47Q16.39 13.46 16.13 13.46L16.13 13.46L16.13 13.46Q15.78 13.46 15.43 13.47L15.43 13.47L15.43 13.47Q15.08 13.48 14.77 13.50L14.77 13.50L14.77 13.50Q14.46 13.52 14.23 13.56L14.23 13.56L14.23 13.56Q13.99 13.59 13.87 13.64L13.87 13.64L13.87 13.64Q13.73 13.71 13.66 13.70L13.66 13.70L13.66 13.70Q13.59 13.69 13.51 13.61L13.51 13.61L13.51 13.61Q13.47 13.57 13.44 13.52L13.44 13.52L13.44 13.52Q13.40 13.48 13.38 13.44L13.38 13.44L13.38 13.44Q13.36 13.40 13.38 13.36L13.38 13.36L13.38 13.36Q13.40 13.32 13.47 13.30L13.47 13.30L13.47 13.30Q13.53 13.29 13.53 13.25L13.53 13.25L13.53 13.25Q13.54 13.21 13.51 13.17L13.51 13.17L13.51 13.17Q13.49 13.13 13.47 13.09L13.47 13.09L13.47 13.09Q13.44 13.04 13.44 13.01L13.44 13.01L13.44 13.01Q13.45 12.95 13.63 12.72L13.63 12.72L13.63 12.72Q13.82 12.49 14.13 12.15L14.13 12.15L14.13 12.15Q14.44 11.81 14.85 11.39L14.85 11.39L14.85 11.39Q15.26 10.97 15.70 10.53L15.70 10.53L15.70 10.53Q16.14 10.08 16.58 9.64L16.58 9.64L16.58 9.64Q17.03 9.19 17.42 8.81L17.42 8.81L17.42 8.81Q17.23 8.79 16.96 8.78L16.96 8.78L16.96 8.78Q16.69 8.77 16.39 8.77L16.39 8.77L16.39 8.77Q16.13 8.77 15.87 8.78L15.87 8.78L15.87 8.78Q15.61 8.78 15.38 8.79L15.38 8.79L15.38 8.79Q15.15 8.80 14.97 8.82L14.97 8.82L14.97 8.82Q14.80 8.83 14.71 8.84L14.71 8.84L14.71 8.84Q14.62 8.85 14.57 8.84L14.57 8.84L14.57 8.84Q14.53 8.83 14.52 8.81L14.52 8.81L14.52 8.81Q14.51 8.78 14.50 8.75L14.50 8.75L14.50 8.75Q14.50 8.72 14.49 8.70L14.49 8.70L14.49 8.70Q14.46 8.68 14.43 8.66L14.43 8.66L14.43 8.66Q14.40 8.64 14.38 8.61L14.38 8.61L14.38 8.61Q14.36 8.59 14.36 8.56L14.36 8.56L14.36 8.56Q14.35 8.52 14.38 8.49L14.38 8.49L14.38 8.49Q14.40 8.46 14.39 8.44L14.39 8.44L14.39 8.44Q14.37 8.42 14.34 8.40L14.34 8.40L14.34 8.40Q14.31 8.39 14.29 8.36L14.29 8.36L14.29 8.36Q14.26 8.33 14.26 8.29L14.26 8.29L14.26 8.29Q14.26 8.22 14.26 8.15L14.26 8.15L14.26 8.15Q14.27 8.08 14.32 8.07L14.32 8.07L14.32 8.07Q14.38 8.05 14.38 8.00L14.38 8.00L14.38 8.00Q14.39 7.94 14.49 7.89L14.49 7.89L14.49 7.89Q14.57 7.83 14.76 7.80L14.76 7.80L14.76 7.80Q14.94 7.77 15.19 7.75L15.19 7.75L15.19 7.75Q15.44 7.73 15.74 7.72L15.74 7.72L15.74 7.72Q16.04 7.72 16.37 7.72L16.37 7.72L16.37 7.72Q16.69 7.72 17.01 7.72L17.01 7.72L17.01 7.72Q17.34 7.72 17.63 7.73L17.63 7.73L17.63 7.73Q17.93 7.74 18.19 7.74L18.19 7.74L18.19 7.74Q18.44 7.75 18.63 7.75L18.63 7.75L18.63 7.75Q18.69 7.75 18.76 7.80L18.76 7.80L18.76 7.80Q18.83 7.85 18.88 7.93L18.88 7.93L18.88 7.93Q18.94 8.00 18.96 8.09L18.96 8.09L18.96 8.09Q18.98 8.18 18.94 8.25ZM23.63 13.04L23.63 13.04L23.63 13.04Q23.68 13.10 23.67 13.16L23.67 13.16L23.67 13.16Q23.65 13.22 23.61 13.27L23.61 13.27L23.61 13.27Q23.57 13.32 23.51 13.34L23.51 13.34L23.51 13.34Q23.45 13.36 23.41 13.34L23.41 13.34L23.41 13.34Q23.31 13.32 23.20 13.36L23.20 13.36L23.20 13.36Q23.10 13.40 23.06 13.43L23.06 13.43L23.06 13.43Q23.02 13.47 23.04 13.52L23.04 13.52L23.04 13.52Q23.06 13.57 23.10 13.62L23.10 13.62L23.10 13.62Q23.15 13.69 23.11 13.77L23.11 13.77L23.11 13.77Q23.06 13.85 22.96 13.84L22.96 13.84L22.96 13.84Q22.92 13.84 22.81 13.71L22.81 13.71L22.81 13.71Q22.70 13.58 22.54 13.38L22.54 13.38L22.54 13.38Q22.39 13.19 22.21 12.93L22.21 12.93L22.21 12.93Q22.03 12.67 21.85 12.41L21.85 12.41L21.85 12.41Q21.67 12.15 21.50 11.89L21.50 11.89L21.50 11.89Q21.33 11.64 21.21 11.44L21.21 11.44L21.21 11.44Q21.06 11.63 20.87 11.85L20.87 11.85L20.87 11.85Q20.69 12.07 20.50 12.30L20.50 12.30L20.50 12.30Q20.31 12.53 20.13 12.75L20.13 12.75L20.13 12.75Q19.95 12.96 19.80 13.13L19.80 13.13L19.80 13.13Q19.66 13.30 19.56 13.40L19.56 13.40L19.56 13.40Q19.47 13.51 19.45 13.51L19.45 13.51L19.45 13.51Q19.37 13.56 19.32 13.62L19.32 13.62L19.32 13.62Q19.27 13.69 19.17 13.71L19.17 13.71L19.17 13.71Q19.12 13.72 19.08 13.70L19.08 13.70L19.08 13.70Q19.04 13.69 19.01 13.66L19.01 13.66L19.01 13.66Q18.98 13.64 18.94 13.62L18.94 13.62L18.94 13.62Q18.91 13.60 18.87 13.61L18.87 13.61L18.87 13.61Q18.81 13.61 18.77 13.50L18.77 13.50L18.77 13.50Q18.74 13.40 18.83 13.26L18.83 13.26L18.83 13.26Q18.84 13.25 18.94 13.12L18.94 13.12L18.94 13.12Q19.04 13.00 19.21 12.79L19.21 12.79L19.21 12.79Q19.37 12.59 19.57 12.34L19.57 12.34L19.57 12.34Q19.78 12.09 20.00 11.82L20.00 11.82L20.00 11.82Q20.21 11.56 20.43 11.31L20.43 11.31L20.43 11.31Q20.64 11.05 20.82 10.86L20.82 10.86L20.82 10.86Q20.60 10.55 20.35 10.17L20.35 10.17L20.35 10.17Q20.10 9.78 19.86 9.43L19.86 9.43L19.86 9.43Q19.62 9.08 19.43 8.81L19.43 8.81L19.43 8.81Q19.24 8.54 19.17 8.46L19.17 8.46L19.17 8.46Q19.09 8.39 19.05 8.33L19.05 8.33L19.05 8.33Q19.02 8.27 19.01 8.23L19.01 8.23L19.01 8.23Q19.00 8.19 19.07 8.18L19.07 8.18L19.07 8.18Q19.10 8.18 19.11 8.15L19.11 8.15L19.11 8.15Q19.12 8.11 19.13 8.08L19.13 8.08L19.13 8.08Q19.14 8.05 19.15 8.03L19.15 8.03L19.15 8.03Q19.17 8.00 19.21 7.98L19.21 7.98L19.21 7.98Q19.28 7.96 19.41 7.96L19.41 7.96L19.41 7.96Q19.54 7.96 19.61 7.93L19.61 7.93L19.61 7.93Q19.70 7.91 19.73 7.93L19.73 7.93L19.73 7.93Q19.76 7.95 19.82 8.01L19.82 8.01L19.82 8.01Q19.84 8.04 19.85 8.03L19.85 8.03L19.85 8.03Q19.85 8.03 19.85 8.00L19.85 8.00L19.85 8.00Q19.85 7.98 19.86 7.96L19.86 7.96L19.86 7.96Q19.87 7.94 19.89 7.93L19.89 7.93L19.89 7.93Q19.95 7.91 19.98 7.90L19.98 7.90L19.98 7.90Q20.02 7.90 20.04 7.83L20.04 7.83L20.04 7.83Q20.05 7.76 20.06 7.76L20.06 7.76L20.06 7.76Q20.07 7.77 20.15 7.83L20.15 7.83L20.15 7.83Q20.17 7.87 20.32 8.07L20.32 8.07L20.32 8.07Q20.47 8.27 20.69 8.58L20.69 8.58L20.69 8.58Q20.90 8.88 21.13 9.24L21.13 9.24L21.13 9.24Q21.37 9.60 21.57 9.95L21.57 9.95L21.57 9.95Q21.78 9.67 22.03 9.32L22.03 9.32L22.03 9.32Q22.29 8.98 22.53 8.66L22.53 8.66L22.53 8.66Q22.77 8.35 22.98 8.12L22.98 8.12L22.98 8.12Q23.18 7.89 23.28 7.83L23.28 7.83L23.28 7.83Q23.36 7.79 23.39 7.77L23.39 7.77L23.39 7.77Q23.43 7.76 23.45 7.76L23.45 7.76L23.45 7.76Q23.48 7.76 23.52 7.80L23.52 7.80L23.52 7.80Q23.58 7.83 23.64 7.85L23.64 7.85L23.64 7.85Q23.70 7.87 23.74 7.93L23.74 7.93L23.74 7.93Q23.80 7.99 23.80 8.06L23.80 8.06L23.80 8.06Q23.81 8.12 23.79 8.20L23.79 8.20L23.79 8.20Q23.78 8.23 23.67 8.39L23.67 8.39L23.67 8.39Q23.56 8.56 23.34 8.85L23.34 8.85L23.34 8.85Q23.12 9.15 22.77 9.57L22.77 9.57L22.77 9.57Q22.43 10.00 21.94 10.58L21.94 10.58L21.94 10.58Q22.07 10.81 22.24 11.08L22.24 11.08L22.24 11.08Q22.42 11.35 22.60 11.61L22.60 11.61L22.60 11.61Q22.78 11.87 22.95 12.12L22.95 12.12L22.95 12.12Q23.12 12.36 23.26 12.55L23.26 12.55L23.26 12.55Q23.41 12.75 23.51 12.88L23.51 12.88L23.51 12.88Q23.60 13.01 23.63 13.04ZM29.19 11.40L29.19 11.40L29.19 11.40Q29.19 11.79 29.02 12.20L29.02 12.20L29.02 12.20Q28.85 12.60 28.54 12.93L28.54 12.93L28.54 12.93Q28.23 13.26 27.78 13.47L27.78 13.47L27.78 13.47Q27.34 13.69 26.78 13.69L26.78 13.69L26.78 13.69Q26.33 13.69 25.87 13.49L25.87 13.49L25.87 13.49Q25.41 13.30 25.04 12.94L25.04 12.94L25.04 12.94Q24.67 12.58 24.44 12.07L24.44 12.07L24.44 12.07Q24.21 11.56 24.21 10.92L24.21 10.92L24.21 10.92Q24.21 10.29 24.45 9.73L24.45 9.73L24.45 9.73Q24.69 9.17 25.09 8.75L25.09 8.75L25.09 8.75Q25.48 8.33 25.99 8.08L25.99 8.08L25.99 8.08Q26.50 7.83 27.04 7.83L27.04 7.83L27.04 7.83Q27.54 7.83 27.89 7.97L27.89 7.97L27.89 7.97Q28.23 8.10 28.44 8.28L28.44 8.28L28.44 8.28Q28.66 8.46 28.75 8.65L28.75 8.65L28.75 8.65Q28.84 8.85 28.84 8.96L28.84 8.96L28.84 8.96Q28.84 9.22 28.73 9.39L28.73 9.39L28.73 9.39Q28.62 9.55 28.48 9.63L28.48 9.63L28.48 9.63Q28.34 9.71 28.22 9.72L28.22 9.72L28.22 9.72Q28.09 9.73 28.05 9.68L28.05 9.68L28.05 9.68Q28.03 9.65 28.00 9.65L28.00 9.65L28.00 9.65Q27.97 9.65 27.93 9.67L27.93 9.67L27.93 9.67Q27.90 9.68 27.87 9.69L27.87 9.69L27.87 9.69Q27.84 9.71 27.82 9.69L27.82 9.69L27.82 9.69Q27.78 9.68 27.81 9.63L27.81 9.63L27.81 9.63Q27.84 9.58 27.84 9.55L27.84 9.55L27.84 9.55Q27.84 9.49 27.84 9.41L27.84 9.41L27.84 9.41Q27.84 9.33 27.87 9.24L27.87 9.24L27.87 9.24Q27.93 9.12 27.92 8.97L27.92 8.97L27.92 8.97Q27.91 8.83 27.82 8.70L27.82 8.70L27.82 8.70Q27.73 8.57 27.53 8.48L27.53 8.48L27.53 8.48Q27.34 8.39 27.03 8.39L27.03 8.39L27.03 8.39Q26.81 8.39 26.51 8.53L26.51 8.53L26.51 8.53Q26.21 8.67 25.94 8.98L25.94 8.98L25.94 8.98Q25.67 9.28 25.48 9.75L25.48 9.75L25.48 9.75Q25.29 10.22 25.29 10.87L25.29 10.87L25.29 10.87Q25.29 11.15 25.36 11.46L25.36 11.46L25.36 11.46Q25.44 11.76 25.62 12.02L25.62 12.02L25.62 12.02Q25.81 12.28 26.12 12.45L26.12 12.45L26.12 12.45Q26.43 12.62 26.92 12.62L26.92 12.62L26.92 12.62Q27.24 12.62 27.51 12.53L27.51 12.53L27.51 12.53Q27.78 12.44 28 12.30L28 12.30L28 12.30Q28.22 12.17 28.39 12.00L28.39 12.00L28.39 12.00Q28.56 11.84 28.68 11.69L28.68 11.69L28.68 11.69Q28.79 11.55 28.86 11.44L28.86 11.44L28.86 11.44Q28.92 11.33 28.94 11.30L28.94 11.30L28.94 11.30Q28.96 11.27 29.00 11.25L29.00 11.25L29.00 11.25Q29.05 11.23 29.09 11.24L29.09 11.24L29.09 11.24Q29.13 11.25 29.16 11.29L29.16 11.29L29.16 11.29Q29.19 11.33 29.19 11.40ZM32.44 13.19L32.44 13.19L32.44 13.19Q32.85 13.19 33.25 13.27L33.25 13.27L33.25 13.27Q33.66 13.34 33.99 13.52L33.99 13.52L33.99 13.52Q34.32 13.70 34.52 13.99L34.52 13.99L34.52 13.99Q34.72 14.28 34.72 14.72L34.72 14.72L34.72 14.72Q34.72 15.04 34.57 15.37L34.57 15.37L34.57 15.37Q34.42 15.70 34.15 16.00L34.15 16.00L34.15 16.00Q33.89 16.31 33.53 16.58L33.53 16.58L33.53 16.58Q33.17 16.86 32.75 17.06L32.75 17.06L32.75 17.06Q32.33 17.26 31.88 17.38L31.88 17.38L31.88 17.38Q31.43 17.49 30.98 17.49L30.98 17.49L30.98 17.49Q30.61 17.49 30.29 17.41L30.29 17.41L30.29 17.41Q29.96 17.34 29.72 17.18L29.72 17.18L29.72 17.18Q29.48 17.02 29.33 16.79L29.33 16.79L29.33 16.79Q29.19 16.55 29.19 16.23L29.19 16.23L29.19 16.23Q29.19 15.91 29.31 15.64L29.31 15.64L29.31 15.64Q29.44 15.36 29.64 15.13L29.64 15.13L29.64 15.13Q29.84 14.90 30.10 14.71L30.10 14.71L30.10 14.71Q30.36 14.52 30.64 14.39L30.64 14.39L30.64 14.39Q30.91 14.27 31.18 14.20L31.18 14.20L31.18 14.20Q31.45 14.13 31.66 14.13L31.66 14.13L31.66 14.13Q31.78 14.14 31.82 14.16L31.82 14.16L31.82 14.16Q31.86 14.18 31.86 14.20L31.86 14.20L31.86 14.20Q31.86 14.22 31.84 14.25L31.84 14.25L31.84 14.25Q31.82 14.28 31.82 14.30L31.82 14.30L31.82 14.30Q31.83 14.34 31.85 14.40L31.85 14.40L31.85 14.40Q31.86 14.45 31.86 14.51L31.86 14.51L31.86 14.51Q31.86 14.57 31.84 14.63L31.84 14.63L31.84 14.63Q31.81 14.68 31.74 14.69L31.74 14.69L31.74 14.69Q31.45 14.76 31.11 14.92L31.11 14.92L31.11 14.92Q30.76 15.09 30.46 15.31L30.46 15.31L30.46 15.31Q30.15 15.53 29.95 15.79L29.95 15.79L29.95 15.79Q29.74 16.04 29.74 16.30L29.74 16.30L29.74 16.30Q29.74 16.43 29.85 16.48L29.85 16.48L29.85 16.48Q29.97 16.54 30.18 16.54L30.18 16.54L30.18 16.54Q30.44 16.54 30.80 16.46L30.80 16.46L30.80 16.46Q31.17 16.39 31.55 16.25L31.55 16.25L31.55 16.25Q31.94 16.11 32.32 15.90L32.32 15.90L32.32 15.90Q32.70 15.70 33.01 15.45L33.01 15.45L33.01 15.45Q33.31 15.20 33.50 14.90L33.50 14.90L33.50 14.90Q33.68 14.61 33.68 14.27L33.68 14.27L33.68 14.27Q33.68 14.11 33.62 14.02L33.62 14.02L33.62 14.02Q33.55 13.92 33.47 13.88L33.47 13.88L33.47 13.88Q33.38 13.83 33.29 13.82L33.29 13.82L33.29 13.82Q33.20 13.81 33.13 13.81L33.13 13.81L33.13 13.81Q32.65 13.81 32.14 13.87L32.14 13.87L32.14 13.87Q31.64 13.92 31.22 13.99L31.22 13.99L31.22 13.99Q30.81 14.05 30.54 14.11L30.54 14.11L30.54 14.11Q30.28 14.17 30.26 14.17L30.26 14.17L30.26 14.17Q30.11 14.17 29.99 14.11L29.99 14.11L29.99 14.11Q29.86 14.05 29.77 13.95L29.77 13.95L29.77 13.95Q29.68 13.86 29.63 13.73L29.63 13.73L29.63 13.73Q29.58 13.60 29.58 13.47L29.58 13.47L29.58 13.47Q29.58 13.37 29.70 13.18L29.70 13.18L29.70 13.18Q29.83 12.98 30.02 12.76L30.02 12.76L30.02 12.76Q30.22 12.53 30.48 12.31L30.48 12.31L30.48 12.31Q30.73 12.09 30.99 11.95L30.99 11.95L30.99 11.95Q30.76 11.83 30.58 11.65L30.58 11.65L30.58 11.65Q30.39 11.47 30.27 11.27L30.27 11.27L30.27 11.27Q30.14 11.06 30.07 10.83L30.07 10.83L30.07 10.83Q30.00 10.60 30.00 10.36L30.00 10.36L30.00 10.36Q30.00 9.90 30.13 9.54L30.13 9.54L30.13 9.54Q30.26 9.18 30.47 8.91L30.47 8.91L30.47 8.91Q30.69 8.65 30.95 8.47L30.95 8.47L30.95 8.47Q31.21 8.29 31.47 8.18L31.47 8.18L31.47 8.18Q31.73 8.07 31.96 8.03L31.96 8.03L31.96 8.03Q32.20 7.98 32.35 7.98L32.35 7.98L32.35 7.98Q32.43 7.98 32.48 7.99L32.48 7.99L32.48 7.99Q32.53 8.00 32.57 8.01L32.57 8.01L32.57 8.01Q32.74 7.74 32.97 7.43L32.97 7.43L32.97 7.43Q33.19 7.12 33.42 6.81L33.42 6.81L33.42 6.81Q33.66 6.51 33.90 6.23L33.90 6.23L33.90 6.23Q34.13 5.95 34.33 5.74L34.33 5.74L34.33 5.74Q34.52 5.52 34.66 5.40L34.66 5.40L34.66 5.40Q34.79 5.27 34.84 5.27L34.84 5.27L34.84 5.27Q34.90 5.27 34.99 5.35L34.99 5.35L34.99 5.35Q35.08 5.43 35.16 5.53L35.16 5.53L35.16 5.53Q35.25 5.63 35.30 5.72L35.30 5.72L35.30 5.72Q35.36 5.81 35.36 5.84L35.36 5.84L35.36 5.84Q35.36 5.88 35.33 5.91L35.33 5.91L35.33 5.91Q35.31 5.93 35.31 5.95L35.31 5.95L35.31 5.95Q35.31 5.99 35.35 6.01L35.35 6.01L35.35 6.01Q35.38 6.04 35.46 6.07L35.46 6.07L35.46 6.07Q35.47 6.08 35.48 6.08L35.48 6.08L35.48 6.08Q35.49 6.08 35.49 6.10L35.49 6.10L35.49 6.10Q35.49 6.13 35.40 6.19L35.40 6.19L35.40 6.19Q35.31 6.25 35.11 6.42L35.11 6.42L35.11 6.42Q34.91 6.58 34.60 6.86L34.60 6.86L34.60 6.86Q34.28 7.15 33.82 7.62L33.82 7.62L33.82 7.62Q33.71 7.72 33.60 7.88L33.60 7.88L33.60 7.88Q33.48 8.03 33.35 8.20L33.35 8.20L33.35 8.20Q33.52 8.29 33.71 8.45L33.71 8.45L33.71 8.45Q33.91 8.61 34.06 8.81L34.06 8.81L34.06 8.81Q34.21 9.02 34.31 9.29L34.31 9.29L34.31 9.29Q34.41 9.56 34.41 9.86L34.41 9.86L34.41 9.86Q34.41 10.52 34.19 10.96L34.19 10.96L34.19 10.96Q33.97 11.41 33.63 11.68L33.63 11.68L33.63 11.68Q33.28 11.95 32.85 12.07L32.85 12.07L32.85 12.07Q32.42 12.18 32.00 12.18L32.00 12.18L32.00 12.18Q31.90 12.18 31.80 12.17L31.80 12.17L31.80 12.17Q31.71 12.17 31.62 12.15L31.62 12.15L31.62 12.15Q31.47 12.26 31.27 12.41L31.27 12.41L31.27 12.41Q31.07 12.56 30.88 12.74L30.88 12.74L30.88 12.74Q30.69 12.91 30.53 13.10L30.53 13.10L30.53 13.10Q30.37 13.28 30.28 13.45L30.28 13.45L30.28 13.45Q30.56 13.44 30.81 13.40L30.81 13.40L30.81 13.40Q31.06 13.36 31.32 13.32L31.32 13.32L31.32 13.32Q31.58 13.27 31.85 13.23L31.85 13.23L31.85 13.23Q32.12 13.19 32.44 13.19ZM32.22 8.83L32.22 8.83L32.22 8.83Q32.22 8.69 32.38 8.36L32.38 8.36L32.38 8.36Q32.06 8.46 31.81 8.67L31.81 8.67L31.81 8.67Q31.55 8.87 31.38 9.13L31.38 9.13L31.38 9.13Q31.20 9.39 31.10 9.69L31.10 9.69L31.10 9.69Q31.01 9.99 31.01 10.28L31.01 10.28L31.01 10.28Q31.01 10.49 31.06 10.69L31.06 10.69L31.06 10.69Q31.11 10.88 31.22 11.04L31.22 11.04L31.22 11.04Q31.33 11.19 31.50 11.28L31.50 11.28L31.50 11.28Q31.68 11.38 31.93 11.38L31.93 11.38L31.93 11.38Q32.20 11.38 32.42 11.28L32.42 11.28L32.42 11.28Q32.63 11.18 32.80 11.02L32.80 11.02L32.80 11.02Q32.96 10.86 33.08 10.66L33.08 10.66L33.08 10.66Q33.19 10.46 33.26 10.26L33.26 10.26L33.26 10.26Q33.33 10.07 33.37 9.90L33.37 9.90L33.37 9.90Q33.40 9.73 33.40 9.63L33.40 9.63L33.40 9.63Q33.40 9.21 33.27 8.99L33.27 8.99L33.27 8.99Q33.13 8.76 32.96 8.64L32.96 8.64L32.96 8.64Q32.86 8.76 32.76 8.86L32.76 8.86L32.76 8.86Q32.66 8.97 32.55 9.08L32.55 9.08L32.55 9.08Q32.53 9.09 32.50 9.09L32.50 9.09L32.50 9.09Q32.48 9.09 32.47 9.07L32.47 9.07L32.47 9.07Q32.46 9.05 32.42 9.05L32.42 9.05L32.42 9.05Q32.40 9.05 32.38 9.07L32.38 9.07L32.38 9.07Q32.36 9.09 32.33 9.09L32.33 9.09L32.33 9.09Q32.28 9.09 32.25 9.04L32.25 9.04L32.25 9.04Q32.22 8.98 32.22 8.83Z"></path></g><!----><!----></svg></a>
        
    </div>

                    <nav class="nav">
    <ul class="menu" id="menu">
        
            
        
        
        
        
            
                <li class="menu-item"><a href="/archives/"><span class="menu-item-name">文章</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/tags/"><span class="menu-item-name">标签</span></a>
                </li>
            
        
            
                <li class="menu-item"><a href="/about/"><span class="menu-item-name">关于</span></a>
                </li>
            
        
            
                
                    
                    
                
            
        
            
                
            
        
    </ul>
</nav>

                    
                </div>
            </div>
            
    <input type="checkbox" id="nav-toggle" aria-hidden="true" />
    <label for="nav-toggle" class="nav-toggle"></label>
    <label for="nav-toggle" class="nav-curtain"></label>


        
    </header>




            
            
    <main class="main single" id="main">
    <div class="main-inner">

        

        <article class="content post h-entry" data-align="justify" data-type="posts" data-toc-num="true">

            <h1 class="post-title p-name">白驱动 Kill AV/EDR（上）</h1>

            

            
                
            

            
                

<div class="post-meta">
    
        
        <time datetime="2023-09-22T16:19:54&#43;08:00" class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M400 64h-48V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H160V12c0-6.627-5.373-12-12-12h-40c-6.627 0-12 5.373-12 12v52H48C21.49 64 0 85.49 0 112v352c0 26.51 21.49 48 48 48h352c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 400H54a6 6 0 0 1-6-6V160h352v298a6 6 0 0 1-6 6zm-52.849-200.65L198.842 404.519c-4.705 4.667-12.303 4.637-16.971-.068l-75.091-75.699c-4.667-4.705-4.637-12.303.068-16.971l22.719-22.536c4.705-4.667 12.303-4.637 16.97.069l44.104 44.461 111.072-110.181c4.705-4.667 12.303-4.637 16.971.068l22.536 22.718c4.667 4.705 4.636 12.303-.069 16.97z"/></svg>&nbsp;2023.9.22</time>
    
    
    
    
        
        
        
            
        
    
    
    
        
        <span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;15&nbsp;分钟</span>
    

   
    

    
    
</div>

            

            <nav class="contents">
  <h2 id="contents" class="contents-title">目录</h2><ol class="toc">
    <li><a id="contents:一些相关的基本概念" href="#一些相关的基本概念">一些相关的基本概念</a></li>
    <li><a id="contents:杀软edr-监控原理" href="#杀软edr-监控原理">杀软/EDR 监控原理</a>
      <ol>
        <li><a id="contents:用户态的组成r3" href="#用户态的组成r3">用户态的组成（R3）</a></li>
        <li><a id="contents:内核态的实现r0" href="#内核态的实现r0">内核态的实现（R0）</a></li>
      </ol>
    </li>
    <li><a id="contents:一个简单的驱动程序" href="#一个简单的驱动程序">一个简单的驱动程序</a></li>
    <li><a id="contents:内核回调机制" href="#内核回调机制">内核回调机制</a>
      <ol>
        <li><a id="contents:实现---远程线程注入拦截" href="#实现---远程线程注入拦截">实现 - 远程线程注入拦截</a></li>
        <li><a id="contents:实现---对edr-进程保护" href="#实现---对edr-进程保护">实现 - 对EDR 进程保护</a></li>
      </ol>
    </li>
    <li><a id="contents:总结" href="#总结">总结</a></li>
    <li><a id="contents:参考" href="#参考">参考</a></li>
  </ol>
</nav><div class="post-body e-content">
                <blockquote>
<p>本文是白驱动Kill AV/EDR 的第一部分，将讨论驱动开发原理，杀软/EDR 监控拦截原理，并且编写驱动简单实现杀软/EDR 对某些行为的拦截。</p>
</blockquote>
<h2 id="一些相关的基本概念"><a href="#一些相关的基本概念" class="anchor-link">#</a><a href="#contents:一些相关的基本概念" class="headings">一些相关的基本概念</a></h2>
<ul>
<li>
<p><strong>进程</strong></p>
<p>进程只进行管理，线程才是真正执行代码的东西。进程拥有的内容如下：</p>
<ol>
<li>可执行程序，保存了原始代码和数据。</li>
<li>私有虚拟地址空间</li>
<li>主令牌，安全上下文对象，线程会用到。</li>
<li>私有句柄表，保存了事件、信号量、文件句柄</li>
</ol>
<p>每个进程在内核中有一个唯一标识符。</p>
</li>
<li>
<p><strong>线程</strong></p>
<p>执行代码的真正实体是线程，线程位于进程之内，使用进程提供的资源来完成任务（例如虚拟内存和内核对象的句柄）</p>
</li>
<li>
<p><strong>虚拟内存</strong></p>
<p>内存以页面为单位进行管理。页面的大小由CPU类型决定，在所有Windows 支持的体系结构里，普通页面大小是4KB。</p>
<p>虚拟内存中的每个页面处于如下三种状态之一：</p>
<ol>
<li>空闲 — 这个页面未被分配，没有任何东西存在，对其进行访问会引起访问违例异常。</li>
<li>已提交 — 已提交的页面通常被映射到RAM 或者文件中。</li>
<li>保留 —  页面未提交，进行新的内存分配时，如果没有指定特定地址的话，将不会在保留的地址范围进行分配。</li>
</ol>
</li>
<li>
<p><strong>系统内存</strong></p>
<p>地址空间的较低部分由进程使用，操作系统本身驻留于系统支持的地址空间的高端部分。系统空间和进程是无关的，因为是同一个系统、同一内核、同一驱动为每个进程提供服务。因此系统空间中的地址都是绝对地址，而不是相对地址。</p>
<p>系统空间是内核所在之处，不同从用户模式直接访问。这也意味着驱动程序的影响是系统范围的。如果一个内核驱动程序产生了内存泄露，那么即使在驱动程序卸载之后也得不到释放。但是在用户模式下，内核会负责关闭并释放任何死进程内部的东西。</p>
</li>
</ul>
<p><strong>系统调用过程</strong></p>
<p>应用程序总是需要进行一些不纯是计算的操作，例如打开文件、分配内存，这些操作最终只能由位于内核模式的代码来进行。</p>
<p>例如： 用户要打开一个文件，记事本会调用CreateFile（Kernel32.dll） 来响应。在进行了错误检查后，CreateFile 会进一步调用NtCreateFile（NTDLL.dll），NTDLL.dll 实际上是位于用户模式最底层的代码，这个NtCreateFile 是执行到内核模式转换的API。</p>
<p>在进行实际的转换之前，它会先把一个叫系统服务号的数字放到一个EAX 寄存器里，然后执行一个特殊的CPU 指令（syscall/sysenter）来实际转换到内核模式，并跳转到系统服务分发器的例程中去，系统服务分发器读取改寄存器中的值，作为系统服务分发表（SSDT）的索引，代码跳转至相应的系统调用中。</p>
<p><img src="/images/16953709776012.jpg" alt=""></p>
<h2 id="杀软edr-监控原理"><a href="#杀软edr-监控原理" class="anchor-link">#</a><a href="#contents:杀软edr-监控原理" class="headings">杀软/EDR 监控原理</a></h2>
<p>传统杀软主要是为了检测拦截主机上的恶意行为和程序，而传统的EDR 并不是为了阻止主机上的恶意活动，而是通过机器学习、行为检测等方式来检测主机上更复杂的恶意活动，并将结果通知到管理员。下面讨论的也是这两者基本通用的检测原理。（<em><strong>Tips:</strong></em> 后文以&quot;EDR&quot; 为&quot;杀软/EDR&quot; 的简称）</p>
<p>大多数EDR 都有一个用户态组件和多个内核态组件，它们会通过驱动在内核中注册多个回调对象来实现进程、线程创建监控，API Hook 等等操作。下面会从用户态和内核态两方面来介绍EDR 监控的大致原理。</p>
<h3 id="用户态的组成r3"><a href="#用户态的组成r3" class="anchor-link">#</a><a href="#contents:用户态的组成r3" class="headings">用户态的组成（R3）</a></h3>
<p>EDR 用户态组件一般由用户态的服务和其用户态的PPL 进程构成。</p>
<blockquote>
<p>Windows Vista首先引入了PP（Protected Process）模型，当时进程要么受保护，要么不受保护。从Windows 8.1 / Server 2012 R2开始，微软引入了Protected Process Light (PPL)的概念。PPL实际上是对以前的受保护进程模型的扩展，并添加了&quot;保护级别&quot; 的概念。进程的保护级别由该进程PE文件的签名级别决定。受保护的进程级别总是大于 PPL 进程，其次高价值的签名者进程可以访问低价值的进程，但反之则不然。</p>
</blockquote>
<p>换句话说：</p>
<ul>
<li>PP 进程可以打开具有完全访问权限的 PP 或 PPL 进程，只要其签名者级别大于或等于；</li>
<li>一个 PPL 进程可以打开另一个具有完全访问权限的 PPL 进程，只要其签名者级别大于或等于；</li>
<li>无论签名者级别如何，PPL 进程都无法以完全访问权限打开 PP 进程。</li>
</ul>
<p>当然未受保护的进程都无法访问PP 和PPL 进程（只能使用受限的访问标志集）。用户态的EDR 进程一般会将进程启动为PPL级别来保护自己避免被用户态程序篡改，这导致PPL 进程只能从Windows 内核中去终止。（经过观察发现国内的杀软/EDR 用户态大多不是PPL 进程，但是它也可以通过内核回调对象实现对其用户态进程的保护，以达到相同的效果，后面会细说代码实现）</p>
<p><em><strong>Tips:</strong></em> 杀软/EDR 的保护级别一般是PsProtectedsignerAntimalware-Light。</p>
<hr>
<p>在后面测试可能会遇到过这样一个问题：</p>
<blockquote>
<p><strong>为什么被终止的EDR 用户态PPL 进程总是会重新初始化（Kill 之后会重启）？以及EDR 的哪个模块进行的这个初始化操作？</strong></p>
</blockquote>
<p>一般来说是由用户态的EDR 服务组件负责初始化和调度EDR 的PPL 进程。如下图，从左到右，第一个窗口是EDR 的PPL进程，第二个窗口是EDR 的服务进程，第三个窗口是这个服务的介绍。</p>
<p><img src="/images/16953710050745.jpg" alt=""></p>
<p>按理说如果能关闭EDR 的用户态服务，那么就能完全关闭掉EDR 的用户态组件。但是EDR 通常将其用户态服务初始化为受保护的服务，受保护的服务初始化是由一个叫Early Launch Antimalware 的EDR驱动程序完成的，这个内核驱动程序不允许停止、禁用这个受保护服务以及不允许修改它的注册表项启动类型来关闭（某些情况下，有的EDR 能修改成功，但重启后修改的值会被重置），如下图。</p>
<p><img src="/images/16953710258941.jpg" alt=""></p>
<h3 id="内核态的实现r0"><a href="#内核态的实现r0" class="anchor-link">#</a><a href="#contents:内核态的实现r0" class="headings">内核态的实现（R0）</a></h3>
<p>EDR 的核心拦截能力主要在内核中实现。通过在内核中注册回调例程，EDR 可以在用户态创建进程、注册表操作、对象获取等等方面进行监控和拦截，属于系统底层的拦截机制。在Windows XP SP3 发布之前，EDR 可以在Windows 内核中进行Hook，比如对SSDT 表的Hook，但微软为了Windows 内核稳定引入了Patch Guard 到内核中。</p>
<blockquote>
<p>Patch Guard 会在不规则的时间间隔内来检查 Windows 内核中某些代码区域是否存在诸如挂钩之类的操作，在必要时通过蓝屏死机 (BSOD) 来阻止 Windows 的进一步执行。Patch Guard 也有Bypass 方法，但现在的杀软/EDR 一般不会用bypass 来绕过，因为可能会导致蓝屏。</p>
</blockquote>
<p>虽然微软引入了Patch Guard 来禁止EDR 在内核中进行Hook 操作，但是它也引入了另一种机制 — 内核回调对象来让EDR 可以在内核中实现保护、检测策略。内核回调机制允许EDR 通过筛选器驱动程序以回调例程的形式注册回调对象，这允许EDR在Windows内核的回调数组中注册不同的回调例程。</p>
<p>举个例子：EDR 在内核中注册了在回调数组中注册了一个进程通知的回调例程，那么进程在用户态中被创建和终止时，都会触发这个回调通知，这样EDR 就知道哪个进程被创建了，从而进行后面一系列的保护或检测操作。</p>
<p>例如注入DLL 去Hook API 来实现恶意代码检测、内存页面保护等。下面简单介绍一下EDR 在用户态的Hook 原理：</p>
<p><img src="/images/16953710419701.jpg" alt="">
上面借用@Daniel Feichter 的图来说明，以VirtualAlloc 和 NtAllocateVirtualMemory 为例，EDR 一般会在kernel32.dll 或 NTDLL.dll 中进行Hook，EDR 可以通过JMP 指令（或其他Hook 库）将调用重定向到EDR注入的Dll 中，这样EDR就能分析的参数、调用的上下文代码等信息，如果没有扫描出恶意代码或行为，才会进行后续正常的调用逻辑。</p>
<p>当然绕过用户态的函数Hook的方法也有很多，可以通过直接系统调用、间接系统调用（两种系统调用都可以被检测）、内存中反汇编等方式绕过。在windbg 调试中，发现几个常见的国内杀软和EDR并没有对Kernel32.dll 和ntdll.dll 函数调用做Hook。</p>
<h2 id="一个简单的驱动程序"><a href="#一个简单的驱动程序" class="anchor-link">#</a><a href="#contents:一个简单的驱动程序" class="headings">一个简单的驱动程序</a></h2>
<p>后面会进行简单的驱动程序开发，实现某些EDR 的检测功能，这样有助于理解EDR 在驱动内部的检测原理。不过首先需要搭建驱动开发环境，首先先构建一个最简单的驱动程序。</p>
<ol>
<li>
<p>这里用Visual Studio 2022 进行开发，Visual Studio 2022 只能安装 Windows 11 版本 22H2 WDK（Windows 驱动程序开发工具包）。并且安装WDK 时需要安装对应版本的Windows SDK。</p>
<ol>
<li><a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/download-the-wdk" target="_blank" rel="noopener">下载WDK</a> ，这时候下载的是10.0.22621.382版本。</li>
<li>在Visual Studio 2022上下载，10.0.22621.3.0 版本的SDK。</li>
</ol>
</li>
<li>
<p>在下载好后，新建项目就能看到Empty WDM Driver模板并选择创建项目，创建完项目后删除生成的.inf 文件。
<img src="/images/16953710836499.jpg" alt=""></p>
</li>
<li>
<p>一个Hello Word 驱动程序</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ntddk.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//入口函数，相当于main
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">pRegPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">pRegPath</span><span class="p">);</span> <span class="c1">// 解决pRegPath 变量的未引用报警
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">KdPrint</span><span class="p">((</span><span class="s">&#34;DriverEntry ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//用于驱动程序卸载时执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">pDriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">KdPrint</span><span class="p">((</span><span class="s">&#34;DriverUnload ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
<li>
<p>点击编译，会发现有报错，需要在Visual Studio 2022 上安装缓解了 Spectre 漏洞的库。在VS上安装即可，此处版本要对应上。
<img src="/images/16953711256227.jpg" alt=""></p>
</li>
<li>
<p>生成sys 驱动文件
<img src="/images/16953711615219.jpg" alt=""></p>
</li>
<li>
<p>加载驱动</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-powershell" data-lang="powershell"><span class="line"><span class="cl"><span class="c">#本机打开测试签名模式，并重启</span>
</span></span><span class="line"><span class="cl"><span class="n">bcdedit</span> <span class="p">/</span><span class="nb">set </span><span class="n">testsigning</span> <span class="n">on</span>
</span></span><span class="line"><span class="cl"><span class="c">#安装驱动</span>
</span></span><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">create</span> <span class="n">DriverTest</span> <span class="n">type</span><span class="p">=</span> <span class="n">kernel</span> <span class="n">binPath</span><span class="p">=</span> <span class="s2">&#34;C:\Users\Administrator\MyDriver.sys&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c">#加载驱动</span>
</span></span><span class="line"><span class="cl"><span class="nb">sc start </span><span class="n">DriverTest</span>
</span></span><span class="line"><span class="cl"><span class="c">#卸载驱动</span>
</span></span><span class="line"><span class="cl"><span class="nb">sc </span><span class="n">stop</span> <span class="n">DriverTest</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>下图可以看到加载驱动和卸载驱动的输出</p>
<p><img src="/images/16953711739953.jpg" alt=""></p>
</li>
</ol>
<h2 id="内核回调机制"><a href="#内核回调机制" class="anchor-link">#</a><a href="#contents:内核回调机制" class="headings">内核回调机制</a></h2>
<p>这种机制简单来说就是在系统某些事情发生时驱动程序可以得到通知。</p>
<p>比如EDR 可以注册很多个回调例程，可以这些回调例程可以在进程与线程创建销毁、映像加载、注册表修改、对象获取、文件系统等操作时获得通知，这样EDR 就可以很好的对这些内容进行监控、拦截等操作。</p>
<p>下面通过编写代码模拟EDR 驱动、EDR 用户态进程来实现一个简易版的EDR。</p>
<h3 id="实现---远程线程注入拦截"><a href="#实现---远程线程注入拦截" class="anchor-link">#</a><a href="#contents:实现---远程线程注入拦截" class="headings">实现 - 远程线程注入拦截</a></h3>
<p>大家都知道某数字杀软在某个模式下，会对远程线程注入进行拦截。下面就来自己实现一下，从内核中禁止远程线程注入。</p>
<p>基本逻辑如下：驱动程序检测到远程线程注入，用户态进程（模拟EDR 进程）通过与驱动程序通信获取到这个恶意行为，然后用户态的进程弹窗提示被拦截。实现效果如下图所示：
<img src="/images/16953712117568.jpg" alt="">
检测原理：</p>
<p>驱动程序通过<code>PsSetCreateThreadNotifyRoutine()</code>注册系统中线程创建与销毁的回调函数，这样系统中只要有线程的创建和销毁时，都会执行我们定义的回调函数。远程线程的创建者是发起注入进程的PID而不是这个线程所在进程的PID，通过此检测逻辑即可判断是否是远程线程注入。然后，将符合远程进程创建条件的就记录在一个双向链表中，用户端EDR 通过访问驱动的设备对象，读取链表中的值。然后弹窗警告有进程在进行远程线程注入。</p>
<p>以下代码重要代码都写了注释，不逐行分析了。</p>
<ul>
<li>
<p>驱动程序编写（EDR.sys）</p>
<p>实现对远程线程注入的检测</p>
<ul>
<li>
<p>main.c</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ntddk.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">ThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">Create_ProcessId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">Belong_ProcessId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">ThreadData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">Entry</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ThreadData</span> <span class="n">Data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">Item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">FAST_MUTEX</span> <span class="n">Mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">ItemCount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">LIST_ENTRY</span> <span class="n">Header</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">Global</span><span class="p">;</span><span class="c1">//全局变量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">Global</span> <span class="n">global</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ThreadNotify</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">ProcessId</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">ThreadId</span><span class="p">,</span> <span class="n">BOOLEAN</span> <span class="n">Create</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DispatchFuncRead</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DispatchFuncDefault</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">PushItem</span><span class="p">(</span><span class="n">LIST_ENTRY</span><span class="o">*</span> <span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//入口函数，相当于main
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">pRegPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">pRegPath</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">DevName</span> <span class="o">=</span> <span class="nf">RTL_CONSTANT_STRING</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\</span><span class="s">Device</span><span class="se">\\</span><span class="s">RemoteThreadDev&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//创建设备对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="nf">IoCreateDevice</span><span class="p">(</span><span class="n">pDriverObject</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DevName</span><span class="p">,</span> <span class="n">FILE_DEVICE_UNKNOWN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;设备对象创建失败 (0x%08X)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="n">DeviceObject</span><span class="o">-&gt;</span><span class="n">Flags</span> <span class="o">|=</span> <span class="n">DO_DIRECT_IO</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//提供符号链接使得设备能够被用户态的调用者访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//下面创建了一个符号链接并将其与我们的设备对象连接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">UNICODE_STRING</span> <span class="n">SymbolicLink</span> <span class="o">=</span> <span class="nf">RTL_CONSTANT_STRING</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\</span><span class="s">??</span><span class="se">\\</span><span class="s">RemoteThreadCheck&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="nf">IoCreateSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">DevName</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;符号链接创建失败 (0x%08X)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//创建失败时 要销毁设备对象
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">IoDeleteDevice</span><span class="p">(</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//此函数是用于注册线程创建和销毁的回调通知
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">status</span> <span class="o">=</span> <span class="nf">PsSetCreateThreadNotifyRoutine</span><span class="p">(</span><span class="n">ThreadNotify</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;注册线程回调失败 (0x%08X)</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">status</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//失败情况需要销毁申请的句柄
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">IoDeleteDevice</span><span class="p">(</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">IoDeleteSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SymbolicLink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;线程回调注册成功</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">InitializeListHead</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">);</span><span class="c1">//初始化链表头 LIST_ENTRY结构的双向链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ExInitializeFastMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//指定Create和 Close 分发例程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CLOSE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_CREATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">DispatchFuncDefault</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//指定读设备对象的分发例程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">MajorFunction</span><span class="p">[</span><span class="n">IRP_MJ_READ</span><span class="p">]</span> <span class="o">=</span> <span class="n">DispatchFuncRead</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">NTSTATUS</span> <span class="nf">DispatchFuncRead</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PIO_STACK_LOCATION</span> <span class="n">stack</span> <span class="o">=</span> <span class="nf">IoGetCurrentIrpStackLocation</span><span class="p">(</span><span class="n">Irp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//缓冲区长度
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">ULONG</span> <span class="n">len</span> <span class="o">=</span> <span class="n">stack</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="p">.</span><span class="n">Read</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">NT_ASSERT</span><span class="p">(</span><span class="n">Irp</span><span class="o">-&gt;</span><span class="n">MdlAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//获取缓冲区地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">//此函数返回MdlAddress描述的缓冲区非分页系统虚拟机地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">UCHAR</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">UCHAR</span><span class="o">*</span><span class="p">)</span><span class="nf">MmGetSystemAddressForMdlSafe</span><span class="p">(</span><span class="n">Irp</span><span class="o">-&gt;</span><span class="n">MdlAddress</span><span class="p">,</span> <span class="n">NormalPagePriority</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;获取缓冲区非分页虚拟地址失败&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">STATUS_UNSUCCESSFUL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ExAcquireFastMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//一次性将链表中的内容读出来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="nf">IsListEmpty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">PLIST_ENTRY</span> <span class="n">entry</span> <span class="o">=</span> <span class="nf">RemoveHeadList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">);</span><span class="c1">//去除第一个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">Item</span><span class="o">*</span> <span class="n">info</span> <span class="o">=</span> <span class="nf">CONTAINING_RECORD</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Entry</span><span class="p">);</span><span class="c1">//找到Item结构体地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">ULONG</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ThreadData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">			<span class="c1">//如果缓冲区长度不够 就将原数据插回去 然后在退出
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="nf">InsertTailList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">global</span><span class="p">.</span><span class="n">ItemCount</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">//复制到缓冲区
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">len</span> <span class="o">-=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">count</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="nf">ExFreePool</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ExReleaseFastMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//向用户进程响应请求完成的代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//此分发例程只需要返回请求成功的状态代码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DispatchFuncDefault</span><span class="p">(</span><span class="n">PDEVICE_OBJECT</span> <span class="n">DeviceObject</span><span class="p">,</span> <span class="n">PIRP</span> <span class="n">Irp</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Information</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">Irp</span><span class="o">-&gt;</span><span class="n">IoStatus</span><span class="p">.</span><span class="n">Status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoCompleteRequest</span><span class="p">(</span><span class="n">Irp</span><span class="p">,</span> <span class="n">IO_NO_INCREMENT</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//用于驱动程序卸载时执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">UNICODE_STRING</span> <span class="n">symLink</span> <span class="o">=</span> <span class="nf">RTL_CONSTANT_STRING</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\</span><span class="s">??</span><span class="se">\\</span><span class="s">RemoteThreadCheck&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoDeleteSymbolicLink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">symLink</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">IoDeleteDevice</span><span class="p">(</span><span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">DeviceObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">PsRemoveCreateThreadNotifyRoutine</span><span class="p">(</span><span class="n">ThreadNotify</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">//清除整个链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="nf">IsListEmpty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">PLIST_ENTRY</span> <span class="n">item</span> <span class="o">=</span> <span class="nf">RemoveHeadList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">Item</span><span class="o">*</span> <span class="n">fullitem</span> <span class="o">=</span> <span class="nf">CONTAINING_RECORD</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">ExFreePool</span><span class="p">(</span><span class="n">fullitem</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;DriverUnload ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//触发线程创建销毁时执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">ThreadNotify</span><span class="p">(</span><span class="n">HANDLE</span> <span class="n">ProcessId</span><span class="p">,</span> <span class="n">HANDLE</span> <span class="n">ThreadId</span><span class="p">,</span> <span class="n">BOOLEAN</span> <span class="n">Create</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Create</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//如果线程的所属进程和创建的进程不一致，说明这个线程是远程进程创建的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">//这里只收集新线程的信息，判断处理交给用户态进程
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">Item</span><span class="o">*</span> <span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="n">Item</span> <span class="o">*</span><span class="p">)</span><span class="nf">ExAllocatePool2</span><span class="p">(</span><span class="n">POOL_FLAG_PAGED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Item</span><span class="p">),</span> <span class="err">&#39;</span><span class="n">abcd</span><span class="err">&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">ThreadId</span> <span class="o">=</span> <span class="nf">HandleToUlong</span><span class="p">(</span><span class="n">ThreadId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Create_ProcessId</span> <span class="o">=</span> <span class="nf">HandleToUlong</span><span class="p">(</span><span class="nf">PsGetCurrentProcessId</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">			<span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Belong_ProcessId</span> <span class="o">=</span> <span class="nf">HandleToUlong</span><span class="p">(</span><span class="n">ProcessId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//所有新进程的第一个线程都是由pid为4的System进程创建的，所以需要排除
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>			<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Create_ProcessId</span> <span class="o">!=</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Belong_ProcessId</span> <span class="o">&amp;&amp;</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Create_ProcessId</span> <span class="o">!=</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//到这步检测已完成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;检测到远程线程注入,tid %d ,cpid %d , bpid %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">ThreadId</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Create_ProcessId</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Data</span><span class="p">.</span><span class="n">Belong_ProcessId</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">				<span class="c1">//但是需要把数据传回到用户态的进程，以便弹窗显示威胁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="c1">//将LIST_ENTRY存储到双向链表中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>				<span class="nf">PushItem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">Entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="c1">//ExFreePool(item);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">PushItem</span><span class="p">(</span><span class="n">LIST_ENTRY</span><span class="o">*</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">ExAcquireFastMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">.</span><span class="n">ItemCount</span> <span class="o">&gt;</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">{</span> <span class="c1">//大于1024个就删除第一个添加的程序
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">PLIST_ENTRY</span> <span class="n">pitem</span> <span class="o">=</span> <span class="nf">RemoveHeadList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//CONTAINING_RECORD 根据结构体成员变量的地址计算出结构体地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="nf">ExFreePool</span><span class="p">(</span><span class="nf">CONTAINING_RECORD</span><span class="p">(</span><span class="n">pitem</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Entry</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="n">global</span><span class="p">.</span><span class="n">ItemCount</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//插入新数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">InsertTailList</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Header</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">global</span><span class="p">.</span><span class="n">ItemCount</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="nf">ExReleaseFastMutex</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">Mutex</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
</ul>
</li>
<li>
<p>用户态程序编写（EDRClient.exe ）</p>
<p>用户态程序与驱动进行通信，获取进行远程线程注入的恶意程序信息</p>
<ul>
<li>
<p>main.cpp</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Psapi.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#pragma comment(lib,&#34;psapi.lib&#34;)
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">ThreadId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Create_ProcessId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULONG</span> <span class="n">Belong_ProcessId</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="n">ThreadData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CHAR</span><span class="o">*</span> <span class="nf">GetPathByProcessId</span><span class="p">(</span><span class="n">DWORD</span> <span class="n">dwPid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="n">FALSE</span><span class="p">,</span> <span class="n">dwPid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hProcess</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">CHAR</span><span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHAR</span><span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="n">MAX_PATH</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">GetModuleFileNameExA</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">MAX_PATH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hFile</span> <span class="o">=</span> <span class="nf">CreateFile</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;</span><span class="se">\\\\</span><span class="s">.</span><span class="se">\\</span><span class="s">RemoteThreadCheck&#34;</span><span class="p">,</span> <span class="n">GENERIC_READ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OPEN_EXISTING</span><span class="p">,</span> <span class="n">FILE_ATTRIBUTE_NORMAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">hFile</span> <span class="o">==</span> <span class="n">INVALID_HANDLE_VALUE</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;设备对象打开失败</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BYTE</span><span class="o">*</span> <span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">BYTE</span><span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">DWORD</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nf">ReadFile</span><span class="p">(</span><span class="n">hFile</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bytes</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="p">(</span><span class="n">bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ThreadData</span><span class="o">*</span> <span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="n">ThreadData</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;ThreadId:%d, BelongPid:%d, CreatePid:%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ThreadId</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Belong_ProcessId</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">Create_ProcessId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">CHAR</span><span class="o">*</span> <span class="n">WarningText</span> <span class="o">=</span> <span class="p">(</span><span class="n">CHAR</span><span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">20</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">WarningText</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">CHAR</span><span class="o">*</span> <span class="n">process1</span> <span class="o">=</span> <span class="nf">GetPathByProcessId</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">Create_ProcessId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">CHAR</span><span class="o">*</span> <span class="n">process2</span> <span class="o">=</span> <span class="nf">GetPathByProcessId</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">Belong_ProcessId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">process1</span> <span class="o">&amp;&amp;</span> <span class="n">process2</span> <span class="o">&amp;&amp;</span> <span class="n">process1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">process2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nf">sprintf_s</span><span class="p">(</span><span class="n">WarningText</span><span class="p">,</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">20</span><span class="p">,</span> <span class="s">&#34;进程:</span><span class="se">\n</span><span class="s"> %s </span><span class="se">\n</span><span class="s">在向进程:</span><span class="se">\n</span><span class="s"> %s </span><span class="se">\n</span><span class="s">进行远程线程注入, 注入的线程ID为: %d&#34;</span><span class="p">,</span> <span class="n">process1</span><span class="p">,</span> <span class="n">process2</span><span class="p">,</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">ThreadId</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">MessageBoxA</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">WarningText</span><span class="p">,</span> <span class="s">&#34;警告&#34;</span><span class="p">,</span> <span class="n">MB_OK</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ThreadData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">bytes</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ThreadData</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
</ul>
</li>
<li>
<p>进行远程线程注入的恶意程序（RemoteInject.exe）</p>
<ul>
<li>
<p>main.cpp</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define _CRT_SECURE_NO_WARNINGS
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;Windows.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">szdllname</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">]</span> <span class="o">=</span><span class="s">&#34;kernel32.dll&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;input pid</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hProcess</span> <span class="o">=</span> <span class="nf">OpenProcess</span><span class="p">(</span><span class="n">PROCESS_ALL_ACCESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">LPVOID</span> <span class="n">addralloc</span> <span class="o">=</span> <span class="nf">VirtualAllocEx</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">szdllname</span><span class="p">),</span> <span class="n">MEM_COMMIT</span><span class="p">,</span> <span class="n">PAGE_READWRITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">addralloc</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;alloc mem err!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">WriteProcessMemory</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="n">addralloc</span><span class="p">,</span> <span class="n">szdllname</span><span class="p">,</span> <span class="nf">strlen</span><span class="p">(</span><span class="n">szdllname</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;wirte mem err!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">//获取LoadLibraryA的地址
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="n">PTHREAD_START_ROUTINE</span> <span class="n">pLoadLibrary</span> <span class="o">=</span> <span class="p">(</span><span class="n">PTHREAD_START_ROUTINE</span><span class="p">)</span><span class="nf">GetProcAddress</span><span class="p">(</span><span class="nf">GetModuleHandleA</span><span class="p">(</span><span class="s">&#34;kernel32.dll&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">,</span> <span class="s">&#34;LoadLibraryA&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pLoadLibrary</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;pLoadLibrary mem err!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">HANDLE</span> <span class="n">hThread</span> <span class="o">=</span> <span class="nf">CreateRemoteThread</span><span class="p">(</span><span class="n">hProcess</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pLoadLibrary</span><span class="p">,</span> <span class="n">addralloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hThread</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;CreateRemoteThread err!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="o">-</span><span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">WaitForSingleObject</span><span class="p">(</span><span class="n">hThread</span><span class="p">,</span> <span class="n">INFINITE</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;dll injected successly!</span><span class="se">\r\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;pause&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div></li>
</ul>
</li>
</ul>
<p>按照驱动回调原理来说，如果将RemoteInject.exe 改成系统调用也会弹窗提醒，如下图。</p>
<p><img src="/images/16953712494454.jpg" alt="">
当前对于这种方式的远程线程注入检测，也有绕过方法，但是这篇文章主要是讲EDR，就不展开说。后面有空再写一篇文章来介绍。</p>
<h3 id="实现---对edr-进程保护"><a href="#实现---对edr-进程保护" class="anchor-link">#</a><a href="#contents:实现---对edr-进程保护" class="headings">实现 - 对EDR 进程保护</a></h3>
<p>前面也说到了，国内的大多数杀软/EDR 都不是PPL 进程，那么它是如何保证它的用户态进程不被Kill 的呢？</p>
<p>这里就来实现一下：通过驱动保护上面写的EDRClient.exe 进程不被用户态进程Kill 掉。</p>
<p>这次为了方便，就直接在驱动中写好要保护的进程，这样就不用写与用户态进程通信来获取要保护的进程的代码了。</p>
<p>实现效果图：
<img src="/images/16953712633898.jpg" alt=""></p>
<p>阻止原理：</p>
<p>内核支持在当有进程试图打开或者复制特定对象类型的句柄时通知注册了回调的驱动程序。这里通过<code>ObRegisterCallbacks()</code> 来注册一个操作前回调函数。操作前回调是在实际的句柄创建/打开/复制操作完成之前被调用，这样我们就可以在当有进程打开指定进程句柄前，去除掉句柄中的<code>PROCESS_TERMINATE(1)</code> 权限，使其返回的句柄没有杀死进程的权限。</p>
<p><em><strong>Tips:</strong></em> 当然程序自身调用<code>ExitProcess()</code> 函数是可以退出程序的。并且如果是像notepad 这类有窗口的程序，点击窗口的关闭按钮也可退出。</p>
<p>驱动程序代码如下：</p>
<p>注：使用ObRegisterCallbacks的驱动程序必须在链接时使用<code>/integritycheck</code>参数。</p>
<div class="highlight"><div class="chroma">
<div class="table-container"><table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;ntddk.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//需要保护的进程pid
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ULONG</span> <span class="n">ToProtectPid</span> <span class="o">=</span> <span class="mi">9132</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cp">#define PROCESS_TERMINATE 1
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="n">PVOID</span> <span class="n">RegHandle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">OB_PREOP_CALLBACK_STATUS</span> <span class="nf">OnPreOpenProcess</span><span class="p">(</span><span class="n">PVOID</span>  <span class="n">RegistrationContext</span> <span class="p">,</span> <span class="n">POB_PRE_OPERATION_INFORMATION</span> <span class="n">Info</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">//入口函数，相当于main
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">NTSTATUS</span> <span class="nf">DriverEntry</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">,</span> <span class="n">PUNICODE_STRING</span> <span class="n">pRegPath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">pRegPath</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">OB_OPERATION_REGISTRATION</span> <span class="n">operations</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="n">PsProcessType</span><span class="p">,</span>		
</span></span><span class="line"><span class="cl">			<span class="n">OB_OPERATION_HANDLE_CREATE</span> <span class="o">|</span> <span class="n">OB_OPERATION_HANDLE_DUPLICATE</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			<span class="n">OnPreOpenProcess</span><span class="p">,</span> <span class="nb">NULL</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">	<span class="n">OB_CALLBACK_REGISTRATION</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">OB_FLT_REGISTRATION_VERSION</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">		<span class="mi">1</span><span class="p">,</span>				
</span></span><span class="line"><span class="cl">		<span class="nf">RTL_CONSTANT_STRING</span><span class="p">(</span><span class="sa">L</span><span class="s">&#34;12345.6171&#34;</span><span class="p">),</span>	
</span></span><span class="line"><span class="cl">		<span class="nb">NULL</span><span class="p">,</span>		
</span></span><span class="line"><span class="cl">		<span class="n">operations</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">NTSTATUS</span> <span class="n">status</span> <span class="o">=</span> <span class="nf">ObRegisterCallbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">RegHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nf">NT_SUCCESS</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;failed to register callbacks</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;DriverEntry ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="n">status</span> <span class="o">=</span> <span class="n">STATUS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">pDriverObject</span><span class="o">-&gt;</span><span class="n">DriverUnload</span> <span class="o">=</span> <span class="n">DriverUnload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//用于驱动程序卸载时执行
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">DriverUnload</span><span class="p">(</span><span class="n">PDRIVER_OBJECT</span> <span class="n">pDriverObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">pDriverObject</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//取消注册
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">ObUnRegisterCallbacks</span><span class="p">(</span><span class="n">RegHandle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="nf">KdPrint</span><span class="p">((</span><span class="s">&#34;DriverUnload ok</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">OB_PREOP_CALLBACK_STATUS</span> <span class="nf">OnPreOpenProcess</span><span class="p">(</span><span class="n">PVOID</span>  <span class="n">RegistrationContext</span> <span class="p">,</span> <span class="n">POB_PRE_OPERATION_INFORMATION</span> <span class="n">Info</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UNREFERENCED_PARAMETER</span><span class="p">(</span><span class="n">RegistrationContext</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">Info</span><span class="o">-&gt;</span><span class="n">KernelHandle</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="n">OB_PREOP_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">PEPROCESS</span> <span class="n">process</span> <span class="o">=</span> <span class="p">(</span><span class="n">PEPROCESS</span><span class="p">)</span><span class="n">Info</span><span class="o">-&gt;</span><span class="n">Object</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ULONG</span> <span class="n">pid</span> <span class="o">=</span> <span class="nf">HandleToULong</span><span class="p">(</span><span class="nf">PsGetProcessId</span><span class="p">(</span><span class="n">process</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">	<span class="c1">//是否匹配
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">ToProtectPid</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">Info</span><span class="o">-&gt;</span><span class="n">Parameters</span><span class="o">-&gt;</span><span class="n">CreateHandleInformation</span><span class="p">.</span><span class="n">DesiredAccess</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PROCESS_TERMINATE</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">OB_PREOP_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table></div>
</div>
</div><p>此外<code>CmRegisterCallbackEx()</code>函数可用于注册注册表的回调函数，以便在访问注册表键值时驱动程序可以进行处理。除此之外，驱动程序还可以实现对文件系统的保护，例如禁止删除某个文件。</p>
<h2 id="总结"><a href="#总结" class="anchor-link">#</a><a href="#contents:总结" class="headings">总结</a></h2>
<p>上面我们通过自己编写模拟EDR 的驱动程序和用户态进程，了解EDR 这两个组成部分的通信过程，有助于帮助我们理解EDR大致的工作检测原理，以便思考如何对抗EDR。</p>
<p>通过分析EDR 原理，现在也能大致总结出致盲EDR 几个方法：</p>
<ol>
<li>禁用用户态的服务/进程。</li>
<li>禁用EDR 驱动程序或利用白驱动的任意地址写，修补EDR 的各类回调。</li>
<li>禁用的内核组件过滤器驱动程序或微过滤器驱动程序。</li>
</ol>
<p>其中1、2 两点是咱们有希望能够利用的，第三点对系统影响较大所以暂不考虑。</p>
<p>需要说明的是，第一点禁用用户态的服务和进程在绝大多数情况下是有效的。但是如果EDR 总控通信、监控拦截等主要功能如果写在驱动程序里，那么kill 用户态进程意义不大。测试发现，国内的那些主要杀软/EDR 主要还是很依靠用户态进程进行处理，所以目前来说Kill 用户态进程还是很有效的。</p>
<p>下篇文章中，将会介绍利用白驱动实现去kill 任意进程、进行任意地址写利用的具体方法，敬请期待。</p>
<p>by the way ~ 欢迎关注公众号，新的文章会在公众号上第一时间发布</p>
<p><img src="/images/16953727256091.jpg" alt=""></p>
<h2 id="参考"><a href="#参考" class="anchor-link">#</a><a href="#contents:参考" class="headings">参考</a></h2>
<ol>
<li>《Windows 内核编程》</li>
<li><a href="https://redops.at/en/blog/a-story-about-tampering-edrs" target="_blank" rel="noopener">A story about tampering EDRs</a></li>
</ol>

            </div>

            
    
    
        <ul class="post-copyright">
            <li class="copyright-item author"><span class="copyright-item-text">作者</span>：<a href="https://myzxcg.com/" class="p-author h-card" target="_blank" rel="noopener">myzxcg</a></li>
            
                
                
                
                
                <li class="copyright-item link"><span class="copyright-item-text">链接</span>：<a href="/2023/09/%E7%99%BD%E9%A9%B1%E5%8A%A8-Kill-AV/EDR%E4%B8%8A/" target="_blank" rel="noopener">https://myzxcg.com/2023/09/白驱动-Kill-AV/EDR上/</a></li>
            
            <li class="copyright-item license"><span class="copyright-item-text">许可</span>：<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a></li>
            
        </ul>
    



        </article>

        

        


        


        


        
    
    



        


        
    <footer class="minimal-footer">
        
            <div class="post-tag"><a href="/tags/" rel="tag" class="post-tag-link">#tags</a></div>
        
        
        
            
        
    </footer>



        


        
    
        
        
    
    
    
    
        <ul class="post-nav">
            
            
                <li class="post-nav-next">
                    <a href="/2023/03/%E7%BA%AFC%E9%87%8D%E6%9E%84CS-Beacon-%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%E4%B8%8E%E5%BC%80%E5%8F%91%E5%AE%9E%E7%8E%B0/" rel="next">纯C重构CS Beacon - 原理详解与开发实现 &gt;</a>
                </li>
            
        </ul>
    



        
    

        
            <div class="load-comments">
                <div id="load-comments">加载评论</div>
            </div>
        

        

        

        
            <div id="utterances"></div>
        

        
    



    </div>
</main>


            
    <div id="back-to-top" class="back-to-top">
        <a href="#"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a>
    </div>


            
    <footer id="footer" class="footer">
        <div class="footer-inner">
            

            
    
        <ul class="socials"><li class="socials-item">
                    <a href="https://github.com/myzxcg" target="_blank" rel="external noopener" title="GitHub"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a>
                </li><li class="socials-item">
                    <a href="https://twitter.com/myzxcg" target="_blank" rel="external noopener" title="Twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg></a>
                </li><li class="socials-item">
                    <a href="mailto:myz.xcg@gmail.com" target="_blank" rel="external noopener" title="Email"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 400V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V400H48z"/></svg></a>
                </li><li class="socials-item">
                    <a href="/rss.xml" target="_blank" rel="external noopener" title="RSS"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8 0 4.8V0c13.165 0 24 10.835 24 24h-4.801zM3.291 17.415c1.814 0 3.293 1.479 3.293 3.295 0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526 0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727 0 15.909 7.184 15.909 15.91z"/></svg></a>
                </li></ul>
    


            <div class="site-info">©&nbsp;2023&nbsp;myzxcg&nbsp;| Powered by <a href="https://github.com/reuixiy/hugo-theme-meme" target="_blank" rel="noopener">MemE</a>
              </div>

            
        </div>
    </footer>


        </div>
        

        






    

        

        

        
            <script>
    function loadComments() {
        (function() {
            var utterances = document.getElementById("utterances");
            var script = document.createElement('script');
            script.src = 'https://utteranc.es/client.js';
            script.async = true;
            script.crossOrigin = 'anonymous';
            script.setAttribute('repo', 'myzxcg\/myzxcg.github.io');
            script.setAttribute('issue-term', 'title');
            const isDark = getCurrentTheme() === 'dark';
        if (isDark) {
            script.setAttribute('theme', 'photon-dark');
        } else {
            script.setAttribute('theme', 'github-light');
        }
            
            utterances.appendChild(script);
        })();
    }
</script>
        

        

    



    <script src="https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js"></script>

<script>
    let imgNodes = document.querySelectorAll('div.post-body img');
    imgNodes = Array.from(imgNodes).filter(node => node.parentNode.tagName !== "A");

    mediumZoom(imgNodes, {
        background: 'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'
    })
</script>




    <script src="https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js" type="module" defer></script>







    </body>
</html>
